# å¤šé˜¶æ®µæ„å»º - ç¬¬ä¸€é˜¶æ®µï¼šä½¿ç”¨ Maven æ„å»º
FROM maven:3.9-eclipse-temurin-21 AS builder
WORKDIR /build

# å…ˆå¤åˆ¶ pom.xml å¹¶ä¸‹è½½ä¾èµ–ï¼ˆåˆ©ç”¨ Docker ç¼“å­˜ï¼‰
COPY pom.xml .
RUN echo "ğŸ“¦ [åç«¯] å¼€å§‹ä¸‹è½½ Maven ä¾èµ–..." && \
    mvn dependency:go-offline -B && \
    echo "âœ… [åç«¯] Maven ä¾èµ–ä¸‹è½½å®Œæˆ"

# å¤åˆ¶æºä»£ç å¹¶æ„å»º
COPY src ./src
RUN echo "ğŸ”¨ [åç«¯] å¼€å§‹ç¼–è¯‘ Spring Boot é¡¹ç›®..." && \
    mvn clean package -DskipTests -B && \
    echo "âœ… [åç«¯] ç¼–è¯‘å®Œæˆ"

# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œæ—¶ç¯å¢ƒ
FROM eclipse-temurin:21-jre-alpine
WORKDIR /app

# å®‰è£… curlï¼ˆç”¨äºå¥åº·æ£€æŸ¥ï¼‰
RUN apk add --no-cache curl

# åˆ›å»ºä¸Šä¼ ç›®å½•
RUN mkdir -p /app/uploads/thumbnails

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶ jar æ–‡ä»¶
COPY --from=builder /build/target/*.jar app.jar

# æš´éœ²ç«¯å£
EXPOSE 8080

# è¿è¡Œåº”ç”¨
ENTRYPOINT ["java", "-jar", "app.jar"]
